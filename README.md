# Парсер цен СБИС и Контур

Telegram-бот для автоматического сбора и сравнения цен на тарифы сервисов СБИС и Контур.Экстерн по всем регионам России. Результаты сохраняются в Excel файл и отправляются в указанный Telegram-чат.

---

## Возможности

- Парсинг тарифов **СБИС** по всем регионам России
- Парсинг тарифов **Контур.Экстерн** по всем регионам России
- Сохранение результатов в **Excel файл** с датой в названии
- Отправка готового файла в **Telegram-чат**
- Возможность **отменить парсинг** в любой момент (неполный файл также отправляется)
- Управление через **Telegram-бота** с кнопками

---

## Требования

- Python 3.11+
- Google Chrome (последняя версия)
- ChromeDriver (совместимый с версией Chrome)
- LibreOffice (для конвертации .doc в .docx)

---

## Установка

### 1. Клонировать репозиторий
```bash
git clone <url репозитория>
cd Parser1
```

### 2. Создать виртуальное окружение
```bash
python -m venv venv
```

### 3. Активировать виртуальное окружение

**Windows:**
```bash
venv\Scripts\activate
```

**Linux/Mac:**
```bash
source venv/bin/activate
```

### 4. Установить зависимости
```bash
pip install -r requirements.txt
```

### 5. Настроить конфигурацию

Создать папку `stat` и файл `stat/config.toml`:
```bash
mkdir stat
```

Содержимое `stat/config.toml` (см. раздел Конфигурация ниже).

---

## Конфигурация

Файл `stat/config.toml` должен содержать:

```toml
# Список регионов для СБИС (в формате [код, название])
regions_sbis = [
  ["77", "Москва"], ["78", "Санкт-Петербург"],
  ["01", "Республика Адыгея"], ["02", "Республика Башкортостан"],
  # ... остальные регионы
]

# Список регионов для Контур
regions_kontur = [
  ["01", "Республика Адыгея"], ["02", "Республика Башкортостан"],
  # ... остальные регионы
  ["77", "Москва"], ["78", "Санкт-Петербург"],
]

[telegram]
# Токен бота (получить у @BotFather)
token = "ВАШ_ТОКЕН"
# ID чата для отправки файлов
chat_id = "ВАШ_CHAT_ID"

[urls]
# URL сайта СБИС
sbis_url = "https://saby.ru/tariffs?tab=ereport"
# URL сайта Контур
kontur_url = "https://www.kontur-extern.ru/price-download/77"

[paths]
# Папка для скачивания файлов
download_dir = "downloads"
```

### Как получить Telegram токен:
1. Найдите бота `@BotFather` в Telegram
2. Напишите `/newbot` и следуйте инструкциям
3. Скопируйте полученный токен в `config.toml`

### Как получить chat_id:
1. Добавьте бота в нужный чат
2. Напишите боту `/start`
3. Перейдите по ссылке: `https://api.telegram.org/bot<ВАШ_ТОКЕН>/getUpdates`
4. Найдите значение `"chat": {"id": ...}` - это и есть chat_id

---

## Запуск

```bash
# Активируйте venv (если не активировано)
venv\Scripts\activate        # Windows
source venv/bin/activate     # Linux/Mac

# Запустите бота
python Парсерсулучшеннымконфигом.py
```

---

## Использование

1. Запустите бота командой выше
2. Откройте Telegram и найдите вашего бота
3. Напишите `/start`
4. Выберите кнопку **СБИС** или **Контур**
5. Дождитесь завершения парсинга (или нажмите **Отменить**)
6. Готовый Excel файл придет в указанный Telegram-чат

---

## Структура проекта

```
Parser1/
├── Парсерсулучшеннымконфигом.py   # Основной файл бота
├── requirements.txt                # Зависимости
├── README.md                       # Документация
├── venv/                           # Виртуальное окружение
└── stat/
    ├── config.toml                 # Конфигурация
    ├── bot_log.log                 # Лог файл (создается автоматически)
    ├── downloads/                  # Скачанные файлы (создается автоматически)
    ├── sbis_price_на_ДД.ММ.ГГ.xlsx    # Результат СБИС
    └── kontur_price_на_ДД.ММ.ГГ.xlsx  # Результат Контур
```

---

## Используемые библиотеки

| Библиотека | Версия | Назначение |
|---|---|---|
| aiogram | 3.10.0 | Telegram бот (асинхронный) |
| selenium | 4.20.0 | Автоматизация браузера |
| beautifulsoup4 | 4.12.3 | Парсинг HTML |
| pandas | 2.2.2 | Обработка данных |
| openpyxl | 3.1.2 | Создание Excel файлов |
| python-docx | 1.1.0 | Чтение Word документов |
| PyPDF2 | 3.0.1 | Чтение PDF документов |
| lxml | 5.2.1 | Парсинг XML/HTML |
| toml | 0.10.2 | Чтение конфигурации |
| python-telegram-bot | 20.7 | Отправка файлов в Telegram |

---

## Логирование

Лог файл сохраняется в `stat/bot_log.log`. При каждом запуске лог перезаписывается.

Уровни логирования:
- `......` - информационные сообщения
- `ERROR` - ошибки

---

## Возможные проблемы

**ChromeDriver не найден:**
- Убедитесь что ChromeDriver установлен и его версия совпадает с версией Chrome
- Скачать: https://chromedriver.chromium.org/downloads

**LibreOffice не найден:**
- Установите LibreOffice: https://www.libreoffice.org/download/
- Необходим для конвертации .doc файлов Контур

**Файл config.toml не найден:**
- Убедитесь что папка `stat` существует
- Убедитесь что файл называется именно `config.toml`

**Бот не отвечает:**
- Проверьте правильность токена в config.toml
- Убедитесь что бот запущен (скрипт работает)
